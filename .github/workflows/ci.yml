name: CI Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    lint-and-test:
        name: Lint and Test
        runs-on: ubuntu-latest

        strategy:
            matrix: 
                node-version: [20.x]
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                node-version: ${{ matrix.node-version }}
                cache: 'yarn'
            
            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Generate Prisma Client
              run: yarn prisma generate

            - name: Run ESLint
              run: yarn lint
              continue-on-error: true

            - name: Type check
              run: yarn tsc --noEmit

            - name: Build Next.js app
              run: yarn build
              env:
                NEXT_TELEMETRY_DISABLED: 1
            
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                name: nextjs-build-${{ github.sha }}
                path: .next
                retention-days: 7

    docker-build:
        name: Docker Build Test
        runs-on: ubuntu-latest
        needs: lint-and-test
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                context: .
                file: ./Dockerfile
                push: false
                tags: foundit:test
                cache-from: type=gha
                cache-to: type=gha,mode=max

            - name: Test Docker image
              run: |
                docker run --rm foundit:test node --version

    security-scan:
        name: Security Scanning
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: 'fs'
                scan-ref: '.'
                format: 'sarif'
                output: 'trivy-results.sarif'

            - name: Upload Trivy results to Github Security
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                sarif_file: 'trivy-results.sarif'